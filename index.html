<!-- Created by Charles Ehler for CAVA Area Leader Tool | July 2025 -->
 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAVA Area Leader VISIT Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake {
            animation: shake 0.15s linear 2;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            .print-week {
                page-break-after: always;
            }
            .print-week:last-child {
                page-break-after: auto;
            }
            body {
                background-color: white !important;
                color: black !important;
            }
            .visit-tile {
                background-color: #f3f3f3 !important;
                border-color: #999 !important;
                color: black !important;
            }
            .time-label {
                color: black !important;
            }
            .day-header {
                color: black !important;
                border-color: #999 !important;
            }
        }
        
        .drop-zone {
            min-height: 60px;
        }
        
        .dragging {
            opacity: 0.5;
        }
        
        .period-tab.active {
            border-bottom: 4px solid #009ef4;
            font-weight: bold;
        }
        
        .period-tab.text-gray-400 {
            color: #9CA3AF;
        }

        /* Ensure text wrapping in calendar visit tiles */
        #calendarContainer .visit-tile {
            white-space: normal;
            word-break: break-word;
            overflow-wrap: anywhere;
        }
        
        /* Negative remaining count styling */
        .visit-tile .negative-count {
            display: inline-block;
            background-color: #b00020;
            color: white !important;
            font-weight: bold;
            border-radius: 0.25rem;
            padding: 0.1rem 0.25rem;
            min-width: 1.5rem;
            text-align: center;
        }
    </style>
</head>
<body class="bg-[#ffeab6] min-h-screen font-sans">
    <div class="container mx-auto px-4 py-6">
        <!-- Header Section -->
        <header class="mb-8">
            <div class="flex items-center justify-between w-full">
                <div class="flex items-center">
                    <img src="https://github.com/Charles-Ehler/Cava-Calendar/blob/main/CavaLogo.png?raw=true" alt="CAVA logo" class="w-32 h-32 rounded-lg object-contain mr-4">
                    <div>
                        <h1 class="text-3xl font-bold text-[#009ef4]">Area Leader Visit Calendar</h1>
                        <p class="text-lg text-[#959502]">Schedule your visits for the selected period</p>
                    </div>
                </div>
                <div class="ml-4">
                    <label for="userName" class="block text-sm font-medium text-gray-700 mb-1" style="color: #4B5563; font-weight: 500;">Enter Your Name</label>
                    <input type="text" id="userName" class="w-48 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#009ef4]" placeholder="Your Name">
                </div>
            </div>
        </header>


        <!-- View Instructions Button -->
        <button id="viewInstructionsBtn" class="bg-[#87292f] text-[#ff4c0a] font-bold text-sm py-2 px-4 rounded-md mb-4 hover:underline">
            View Instructions
        </button>

        <!-- Period Tabs -->
        <div class="mb-6 overflow-x-auto">
            <div class="flex space-x-1 min-w-max">
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="1">P1</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="2">P2</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="3">P3</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="4">P4</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="5">P5</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="6">P6</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="7">P7</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="8">P8</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="9">P9</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="10">P10</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="11">P11</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="12">P12</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="13">P13</button>
            </div>
        </div>


        <!-- Main Content -->
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Visit Bank -->
            <aside class="no-print w-full lg:w-1/4 bg-white p-4 rounded-lg shadow-md lg:sticky lg:top-4 lg:self-start">
                <div class="mb-4">
                    <label for="restaurantName" class="block text-sm font-medium text-gray-700 mb-1">Set Visits for the Following Restaurant</label>
                    <input type="text" id="restaurantName" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#009ef4]" placeholder="Restaurant Name">
                </div>
                <div class="mb-4">
                    <label for="restaurantCount" class="block text-sm font-medium text-gray-700 mb-1">Number of Restaurants</label>
                    <input type="number" id="restaurantCount" min="1" max="20" value="1" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#009ef4]">
                </div>
                <button id="generateVisitsBtn" class="w-full px-4 py-3 bg-[#f9d000] text-white rounded-md hover:bg-white hover:text-[#f9d000] focus:outline-none focus:ring-2 focus:ring-[#f9d000] focus:bg-white focus:text-[#f9d000] font-bold animate-none transition">
                    Generate Visits
                </button>
                <div id="restaurantError" class="text-red-500 text-xs mt-1 hidden">Please enter a restaurant name before generating visits.</div>
                <div id="visitBank" class="space-y-2 mt-4 hidden">
                    <h2 class="text-xl font-bold text-[#009ef4] mb-4">Visit Bank</h2>
                    <!-- Visit tiles will be generated here -->
                </div>
            </aside>

            <!-- Calendar -->
            <main class="w-full lg:w-3/4 bg-white p-4 rounded-lg shadow-md">
                <div class="sticky top-0 z-50 bg-white border-b border-gray-200 py-2">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold text-[#009ef4]">
                            <span id="currentPeriodDisplay">P13</span>: 
                            <span id="dateRangeDisplay">Dec 1 - Dec 28, 2025</span>
                        </h2>
                        <div class="flex gap-2 items-center justify-end">
                            <button id="downloadButton" class="no-print px-4 py-2 bg-[#009ef4] text-white rounded-md hover:bg-[#0083d1] focus:outline-none focus:ring-2 focus:ring-[#009ef4] font-medium">
                                Download Calendar (PDF)
                            </button>
                            <button id="resetButton" class="no-print px-4 py-2 bg-[#cc0066] text-white font-bold rounded-lg hover:bg-[#aa0055] focus:outline-none focus:ring-2 focus:ring-[#cc0066]/50 transition-colors">
                                Reset Calendar
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="calendarContainer" class="border border-gray-200 rounded-lg">
                    <div id="calendarWeeks" class="min-w-max space-y-6">
                        <!-- Calendar weeks will be generated here -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Instructions Panel -->
    <div id="instructionsPanel" class="fixed inset-x-0 bottom-0 z-[100] translate-y-full transition-transform duration-300 bg-[#4a9aca] text-[#fff8e8] rounded-t-xl p-6">
        <button id="closeInstructionsBtn" class="absolute top-4 right-4 text-2xl font-bold text-[#fff8e8]">×</button>
        <div class="max-w-4xl mx-auto">
            <h3 class="text-xl font-bold mb-4">Instructions:</h3>
            <ol class="list-decimal pl-5 space-y-2">
                <li>Enter your name at the top right-hand corner—this will appear on the downloaded calendar.</li>
                <li>Confirm the period for scheduling.</li>
                <li>Enter one restaurant's name in the restaurant name field.</li>
                <li>Input the total number of restaurants in your Garden.
                    <ul class="list-disc pl-5 mt-1">
                        <li>Note: This number is only used to calculate how many visits remain (displayed at the bottom of the tiles).</li>
                    </ul>
                </li>
                <li>Click "Generate Visits." This will create all required visits for that restaurant, labeled by type.</li>
                <li>Place the visits on the calendar.</li>
                <li>Then return to the restaurant name field, enter the next location, and click "Generate Visits" again to create a new set of tiles for that restaurant.</li>
                <li>Repeat until you have scheduled all required visits for your Garden.</li>
                <li>Select Download Calendar to send to your RD.
                    <ul class="list-disc pl-5 mt-1">
                        <li>Note: If you need to clear the entire calendar, select Reset Calendar.</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Instructions panel toggle
            const viewInstructionsBtn = document.getElementById('viewInstructionsBtn');
            const closeInstructionsBtn = document.getElementById('closeInstructionsBtn');
            const instructionsPanel = document.getElementById('instructionsPanel');

            viewInstructionsBtn.addEventListener('click', () => {
                instructionsPanel.classList.toggle('translate-y-full');
            });

            closeInstructionsBtn.addEventListener('click', () => {
                instructionsPanel.classList.add('translate-y-full');
            });
            // Period data
            const periods = {
                1: { startDate: new Date('2024-12-30'), endDate: new Date('2025-01-26') },
                2: { startDate: new Date('2025-01-27'), endDate: new Date('2025-02-23') },
                3: { startDate: new Date('2025-02-24'), endDate: new Date('2025-03-23') },
                4: { startDate: new Date('2025-03-24'), endDate: new Date('2025-04-20') },
                5: { startDate: new Date('2025-04-21'), endDate: new Date('2025-05-18') },
                6: { startDate: new Date('2025-05-19'), endDate: new Date('2025-06-15') },
                7: { startDate: new Date('2025-06-16'), endDate: new Date('2025-07-13') },
                8: { startDate: new Date('2025-07-14'), endDate: new Date('2025-08-10') },
                9: { startDate: new Date('2025-08-11'), endDate: new Date('2025-09-07') },
                10: { startDate: new Date('2025-09-08'), endDate: new Date('2025-10-05') },
                11: { startDate: new Date('2025-10-06'), endDate: new Date('2025-11-02') },
                12: { startDate: new Date('2025-11-03'), endDate: new Date('2025-11-30') },
                13: { startDate: new Date('2025-12-01'), endDate: new Date('2025-12-28') }
            };

            // Visit types data with updated rules
            const visitTypes = [
                { 
                    id: 'qra', 
                    name: 'Quarterly Restaurant Audit (QRA)', 
                    duration: 5, 
                    color: 'bg-[#009ef4] text-white', 
                    periods: [1, 5, 8, 11], 
                    perRestaurant: true,
                    maxPerRestaurant: 1,
                    description: '1 per restaurant in P1, P5, P8, P11'
                },
                { 
                    id: 'coaching', 
                    name: 'Coaching Visit', 
                    duration: 2, 
                    color: 'bg-[#959502] text-white', 
                    periods: [2, 3, 4, 6, 7, 9, 10, 12, 13], 
                    perRestaurant: true,
                    maxPerRestaurant: 1,
                    description: '1 per restaurant in P2-P4, P6-P7, P9-P10, P12-P13'
                },
                { 
                    id: 'cash-audit', 
                    name: 'Cash Audit', 
                    duration: 1, 
                    color: 'bg-[#bcdaff] text-black', 
                    periods: 'all', 
                    perRestaurant: true,
                    maxPerRestaurant: 1,
                    description: '1 per restaurant every period'
                },
                { 
                    id: 'gm-impact', 
                    name: 'GM Impact Plan Conversation', 
                    duration: 1, 
                    color: 'bg-[#ff9d00] text-white', 
                    periods: 'all', 
                    perRestaurant: true,
                    maxPerRestaurant: 1,
                    description: '1 per restaurant every period'
                },
                { 
                    id: 'guest-exp', 
                    name: 'Guest Experience Night/Weekend Visit', 
                    duration: 1.5, 
                    color: 'bg-[#da3d9d] text-white', 
                    periods: 'all', 
                    perRestaurant: true,
                    maxPerRestaurant: 1,
                    description: '1 per restaurant every period'
                },
                { 
                    id: 'competency', 
                    name: 'Competency Champion Training', 
                    duration: 1, 
                    color: 'bg-[#e8b2ee] text-black', 
                    periods: 'all', 
                    perRestaurant: false,
                    maxPerGarden: 1,
                    description: '1 per garden/region every period'
                },
                { 
                    id: 'station', 
                    name: 'Station Training Workshop', 
                    duration: 2, 
                    color: 'bg-[#ff4c0a] text-white', 
                    periods: 'all', 
                    perRestaurant: false,
                    maxPerGarden: 1,
                    description: '1 per garden/region every period'
                }
            ];

            // State variables
            let currentPeriod = 1;
            let restaurantName = '';
            let restaurantCount = 1;
            let userName = '';
            // Track period-specific data
            const periodData = {};
            for (let i = 1; i <= 13; i++) {
                periodData[i] = {
                    scheduledVisits: [],
                    remainingUses: {}
                };
                // Initialize remainingUses for all visit types with 0
                visitTypes.forEach(type => {
                    periodData[i].remainingUses[type.id] = 0;
                });
            }

            // DOM elements
            const periodTabs = document.querySelectorAll('.period-tab');
            const restaurantNameInput = document.getElementById('restaurantName');
            const restaurantCountInput = document.getElementById('restaurantCount');
            const userNameInput = document.getElementById('userName');
            const visitBank = document.getElementById('visitBank');
            const calendarWeeks = document.getElementById('calendarWeeks');
            const currentPeriodDisplay = document.getElementById('currentPeriodDisplay');
            const dateRangeDisplay = document.getElementById('dateRangeDisplay');
            const printButton = document.getElementById('printButton');

            // Determine current period based on today's date
            function getCurrentPeriod() {
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Normalize time to midnight for accurate date comparison
                
                // Check each period to see if today falls within its range
                for (let i = 1; i <= 13; i++) {
                    const period = periods[i];
                    const start = new Date(period.startDate);
                    const end = new Date(period.endDate);
                    start.setHours(0, 0, 0, 0);
                    end.setHours(23, 59, 59, 999);
                    
                    if (today >= start && today <= end) {
                        return i;
                    }
                }
                
                // If today is before all periods, return first period
                if (today < periods[1].startDate) {
                    return 1;
                }
                
                // If today is after all periods, return last period
                return 13;
            }

            // Initialize the application
            function init() {
                // Determine current period based on today's date
                currentPeriod = getCurrentPeriod();
                
                loadFromSessionStorage();
                setupEventListeners();
                
                // Hide visit bank by default - it will show when Generate Visits is clicked
                document.getElementById('visitBank').classList.add('hidden');
                
                // Update period tabs styling (will gray out past periods)
                updatePeriodTabsStyle();
                
                // Find and activate the correct period tab
                const activeTab = document.querySelector(`.period-tab[data-period="${currentPeriod}"]`);
                if (activeTab) {
                    // Remove active class from all tabs
                    periodTabs.forEach(tab => tab.classList.remove('active'));
                    // Add active class to current period tab
                    activeTab.classList.add('active');
                }
                
                // Update displays and render calendar for current period
                currentPeriodDisplay.textContent = `P${currentPeriod}`;
                updateDateRangeDisplay();
                renderCalendar();
                updateGenerateButtonState();
            }

            // Update period tabs styling to gray out past periods
            function updatePeriodTabsStyle() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                periodTabs.forEach(tab => {
                    const periodNum = parseInt(tab.dataset.period);
                    const period = periods[periodNum];
                    const endDate = new Date(period.endDate);
                    endDate.setHours(23, 59, 59, 999);
                    
                    // Gray out if period is completely in the past (end date is before today)
                    if (endDate < today) {
                        tab.classList.add('text-gray-400');
                    } else {
                        tab.classList.remove('text-gray-400');
                    }
                });
            }

            // Load data from session storage
            function loadFromSessionStorage() {
                if (sessionStorage.getItem('cavaCalendar')) {
                    const savedData = JSON.parse(sessionStorage.getItem('cavaCalendar'));
                    currentPeriod = savedData.currentPeriod || 13;
                    restaurantName = savedData.restaurantName || '';
                    restaurantCount = savedData.restaurantCount || 1;
                    userName = savedData.userName || '';
                    // Load period data if it exists
                    if (savedData.periodData) {
                        for (let i = 1; i <= 13; i++) {
                            if (savedData.periodData[i]) {
                                periodData[i] = savedData.periodData[i];
                            }
                        }
                    }
                    
                    // Update UI
                    restaurantNameInput.value = restaurantName;
                    restaurantCountInput.value = restaurantCount;
                    userNameInput.value = userName;
                    
                    // Update active period tab
                    periodTabs.forEach(tab => {
                        tab.classList.remove('active');
                        if (parseInt(tab.dataset.period) === currentPeriod) {
                            tab.classList.add('active');
                        }
                    });
                    
                    currentPeriodDisplay.textContent = `P${currentPeriod}`;
                    updateDateRangeDisplay();
                }
            }

            // Save data to session storage
            function saveToSessionStorage() {
                const data = {
                    currentPeriod,
                    restaurantName,
                    restaurantCount,
                    userName,
                    periodData
                };
                sessionStorage.setItem('cavaCalendar', JSON.stringify(data));
            }

            // Update generate button state based on input fields
            function updateGenerateButtonState() {
                // No longer disabling the button based on any condition
            }

            // Set up event listeners
            function setupEventListeners() {
                // Input change listeners
                restaurantNameInput.addEventListener('input', () => {
                    restaurantName = restaurantNameInput.value;
                    updateGenerateButtonState();
                    saveToSessionStorage();
                });

                restaurantCountInput.addEventListener('change', () => {
                    restaurantCount = parseInt(restaurantCountInput.value);
                    updateGenerateButtonState();
                    saveToSessionStorage();
                });

                userNameInput.addEventListener('input', () => {
                    userName = userNameInput.value;
                    updateGenerateButtonState();
                    saveToSessionStorage();
                });

                // Generate visits button
                document.getElementById('generateVisitsBtn').addEventListener('click', () => {
                    // Update state from inputs
                    restaurantName = restaurantNameInput.value;
                    restaurantCount = parseInt(restaurantCountInput.value);
                    userName = userNameInput.value;

                    // Validate restaurant name
                    if (!restaurantName) {
                        restaurantNameInput.classList.add('border-red-500');
                        document.getElementById('restaurantError').classList.remove('hidden');
                        document.getElementById('generateVisitsBtn').classList.remove('animate-none');
                        document.getElementById('generateVisitsBtn').classList.add('animate-shake');
                        
                        // Remove animation after it completes
                        setTimeout(() => {
                            document.getElementById('generateVisitsBtn').classList.remove('animate-shake');
                            document.getElementById('generateVisitsBtn').classList.add('animate-none');
                        }, 500);
                        return;
                    }

                    // Clear validation if previously shown
                    restaurantNameInput.classList.remove('border-red-500');
                    document.getElementById('restaurantError').classList.add('hidden');

                    // Initialize remaining uses based on visit type rules
                    visitTypes.forEach(type => {
                        if (type.periods === 'all' || type.periods.includes(currentPeriod)) {
                            if (type.perRestaurant) {
                                periodData[currentPeriod].remainingUses[type.id] = 
                                    type.maxPerRestaurant * restaurantCount;
                            } else {
                                periodData[currentPeriod].remainingUses[type.id] = 
                                    type.maxPerGarden || 1;
                            }
                        } else {
                            periodData[currentPeriod].remainingUses[type.id] = 0;
                        }
                    });

                    // Show visit bank and update
                    document.getElementById('visitBank').classList.remove('hidden');
                    updateVisitBank();
                    renderCalendar();
                    saveToSessionStorage();
                    
                    // Ensure drag events are properly set up for new tiles
                    document.querySelectorAll('.visit-tile[draggable="true"]').forEach(tile => {
                        tile.addEventListener('dragstart', handleDragStart);
                    });
                });
                // Period tabs
                periodTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        currentPeriod = parseInt(tab.dataset.period);
                        periodTabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        currentPeriodDisplay.textContent = `P${currentPeriod}`;
                        updateDateRangeDisplay();
                        updateVisitBank();
                        renderCalendar();
                        saveToSessionStorage();
                        updatePeriodTabsStyle();
                        
                        // Ensure drag events are properly set up for new tiles
                        document.querySelectorAll('.visit-tile[draggable="true"]').forEach(tile => {
                            tile.addEventListener('dragstart', handleDragStart);
                        });
                    });
                });


                // Reset button
                document.getElementById('resetButton').addEventListener('click', () => {
                    if (confirm('Are you sure you want to reset the calendar? This will remove all scheduled visits.')) {
                        periodData[currentPeriod].scheduledVisits = [];
                        saveToSessionStorage();
                        renderCalendar();
                        updateVisitBank();
                        // Refresh drag-and-drop listeners
                        document.querySelectorAll('.visit-tile[draggable="true"]').forEach(tile => {
                            tile.addEventListener('dragstart', handleDragStart);
                        });
                        document.querySelectorAll('.drop-zone').forEach(zone => {
                            zone.addEventListener('dragover', handleDragOver);
                            zone.addEventListener('dragleave', handleDragLeave);
                            zone.addEventListener('drop', handleDrop);
                            zone.addEventListener('dragenter', e => e.preventDefault());
                        });
                    }
                });
            }

            // Update the date range display (always shows Monday-Sunday range)
            function updateDateRangeDisplay() {
                const period = periods[currentPeriod];
                // Clone dates to avoid modifying originals
                const startDate = new Date(period.startDate);
                const endDate = new Date(period.endDate);
                
                // Adjust start date to next Monday if not already Monday
                if (startDate.getDay() !== 1) {
                    const daysToAdd = startDate.getDay() === 0 ? 1 : 8 - startDate.getDay();
                    startDate.setDate(startDate.getDate() + daysToAdd);
                }
                
                // Adjust end date to next Sunday if not already Sunday
                if (endDate.getDay() !== 0) {
                    const daysToAdd = 7 - endDate.getDay();
                    endDate.setDate(endDate.getDate() + daysToAdd);
                }
                
                const startStr = formatDate(startDate);
                const endStr = formatDate(endDate);
                
                dateRangeDisplay.textContent = `${startStr} - ${endStr}`;
            }

            // Format date as "Mon 3/3"
            function formatDate(date) {
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const dayName = days[date.getDay()];
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const year = date.getFullYear();
                
                return `${dayName} ${month}/${day}/${year}`;
            }

            // Format date as "Mon 3/3" (short version)
            function formatDateShort(date) {
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                const dayName = days[date.getDay() === 0 ? 6 : date.getDay() - 1].substring(0,3);
                const month = date.getMonth() + 1;
                const day = date.getDate();
                
                return `${dayName} ${month}/${day}`;
            }

            // Format date as "M/D" (compact version)
            function formatDateCompact(date) {
                const month = date.getMonth() + 1;
                const day = date.getDate();
                return `${month}/${day}`;
            }

            // Get week date range (Monday-Sunday)
            function getWeekDateRange(startDate, weekNum) {
                // Adjust to the first Monday of the period
                const adjustedStart = new Date(startDate);
                const dayOfWeek = adjustedStart.getDay();
                const daysToAdd = dayOfWeek === 0 ? 1 : dayOfWeek === 1 ? 0 : 8 - dayOfWeek;
                adjustedStart.setDate(adjustedStart.getDate() + daysToAdd);
                
                // Calculate week start (Monday)
                const weekStart = new Date(adjustedStart);
                weekStart.setDate(weekStart.getDate() + (weekNum - 1) * 7);
                
                // Calculate week end (Sunday)
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 6);
                
                return `${formatDateCompact(weekStart)} through ${formatDateCompact(weekEnd)}`;
            }

            // Track remaining uses for each visit type
            const remainingUses = {};

            // Update the visit bank based on current period and restaurant count
            function updateVisitBank() {
                visitBank.innerHTML = '';
                
                const currentVisitTypes = visitTypes.filter(type => {
                    const isInPeriod = type.periods === 'all' || type.periods.includes(currentPeriod);
                    return isInPeriod;
                });
                
                // First calculate remaining counts for all types
                const visitTypesWithCounts = currentVisitTypes.map(type => {
                    const required = type.perRestaurant ? 
                        (type.maxPerRestaurant * restaurantCount) : 
                        (type.maxPerGarden || 1);
                    const scheduled = periodData[currentPeriod].scheduledVisits.filter(v => v.type === type.id).length;
                    const remaining = required - scheduled;
                    
                    return {
                        type,
                        required,
                        scheduled,
                        remaining
                    };
                });
                
                // Sort by remaining counts (positive first, then zero/negative)
                visitTypesWithCounts.sort((a, b) => {
                    if (a.remaining > 0 && b.remaining <= 0) return -1;
                    if (a.remaining <= 0 && b.remaining > 0) return 1;
                    return 0; // Keep original order among same remaining status
                });
                
                // Create tiles in sorted order
                visitTypesWithCounts.forEach(({type, required, scheduled, remaining}) => {
                    const location = restaurantName ? restaurantName : 'Restaurant';
                    createVisitTile(type, location, required, scheduled, remaining);
                });
            }

            // Create a visit tile in the visit bank
            function createVisitTile(type, location, required, scheduled, remaining) {
                const isShortDuration = type.duration <= 1.5;
                
                const tile = document.createElement('div');
                tile.className = `visit-tile ${type.color} p-1.5 rounded-md h-21 flex flex-col justify-between font-medium leading-tight`;
                tile.dataset.type = type.id;
                tile.dataset.duration = type.duration;
                tile.dataset.location = location;
                tile.draggable = true;
                tile.classList.add('cursor-move');
                tile.addEventListener('dragstart', handleDragStart);
                
                const tileTitle = document.createElement('div');
                tileTitle.className = 'font-bold text-base truncate';
                tileTitle.textContent = type.name;
                tileTitle.title = type.name;
                
                const tileLocation = document.createElement('div');
                tileLocation.className = 'text-[10px]';
                tileLocation.textContent = location;
                tileLocation.title = location;
                
                // Add counter display
                const counter = document.createElement('div');
                counter.className = `text-[10px] ${type.id === 'cash-audit' || type.id === 'competency' ? 'text-black' : 'text-gray-200'}`;
                counter.innerHTML = `
                    <div class="flex justify-between text-[10px]">
                        <span>Required</span>
                        <span>Scheduled</span>
                        <span>Remaining</span>
                    </div>
                    <div class="flex justify-between text-[11px] font-medium">
                        <span>${required}</span>
                        <span>${scheduled}</span>
                        <span>${remaining >= 0 ? remaining : `<span class="negative-count">${remaining}</span>`}</span>
                    </div>
                `;
                
                const durationText = document.createElement('div');
                durationText.className = `text-[10px] ${type.id === 'cash-audit' || type.id === 'competency' ? 'text-black' : 'text-gray-200'}`;
                // Format duration display
                let durationTextStr;
                if (type.duration % 1 === 0) {
                    durationTextStr = `${type.duration} ${type.duration === 1 ? 'hr' : 'hrs'}`;
                } else {
                    durationTextStr = `${type.duration * 60} mins`;
                }
                durationText.textContent = durationTextStr;
                
                tile.appendChild(tileTitle);
                tile.appendChild(tileLocation);
                tile.appendChild(durationText);
                tile.appendChild(counter);
                
                // Update location text for restaurant visits
                const locationText = type.perRestaurant ? 
                    (restaurantName ? restaurantName : 'Restaurant') : 
                    location;
                
                visitBank.appendChild(tile);
            }

            // Handle drag start for visit tiles
            function handleDragStart(e) {
                const data = {
                    type: e.target.dataset.type,
                    duration: parseFloat(e.target.dataset.duration),
                    location: e.target.dataset.location
                };
                e.dataTransfer.setData('text/plain', JSON.stringify(data));
                e.target.classList.add('dragging');
                
                // Create and set custom drag image
                const dragImage = e.target.cloneNode(true);
                dragImage.style.width = `${e.target.offsetWidth}px`;
                dragImage.style.height = `${e.target.offsetHeight}px`;
                dragImage.style.position = 'fixed';
                dragImage.style.left = '-9999px';
                dragImage.style.opacity = '0.8';
                document.body.appendChild(dragImage);
                
                e.dataTransfer.setDragImage(dragImage, e.target.offsetWidth / 2, e.target.offsetHeight / 2);
                
                // Clean up after drag ends
                const cleanup = () => {
                    document.body.removeChild(dragImage);
                    e.target.classList.remove('dragging');
                    document.removeEventListener('dragend', cleanup);
                };
                document.addEventListener('dragend', cleanup, { once: true });
            }

            // Render the calendar
            function renderCalendar() {
                calendarWeeks.innerHTML = '';
                
                const period = periods[currentPeriod];
                let currentDate = new Date(period.startDate);
                
                // Adjust to the first Monday of the period (or next Monday if startDate isn't Monday)
                const dayOfWeek = currentDate.getDay();
                const daysToAdd = dayOfWeek === 0 ? 1 : dayOfWeek === 1 ? 0 : 8 - dayOfWeek;
                currentDate.setDate(currentDate.getDate() + daysToAdd);
                
                // Create 4 weeks
                for (let week = 1; week <= 4; week++) {
                    const weekContainer = document.createElement('div');
                    weekContainer.className = 'print-week mb-8';
                    
                    // Week label
                    const weekLabel = document.createElement('div');
                    weekLabel.className = 'text-lg font-bold text-[#009ef4] mb-2 sticky top-0 bg-white z-10';
                    const weekRange = getWeekDateRange(period.startDate, week).replace('–', 'through');
                    
                    // Build label content
                    weekLabel.innerHTML = `Week ${week} <span class="text-black">–</span> ${weekRange}`;
                    
                    // Add name if provided
                    if (userName) {
                        const nameSeparator = document.createElement('span');
                        nameSeparator.className = 'text-black';
                        nameSeparator.textContent = ' – ';
                        
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'font-bold text-[#ff9d77]';
                        nameSpan.textContent = userName;
                        
                        weekLabel.appendChild(nameSeparator);
                        weekLabel.appendChild(nameSpan);
                    }
                    weekContainer.appendChild(weekLabel);
                    
                    // Calendar grid
                    const calendarGrid = document.createElement('div');
                    calendarGrid.className = 'grid grid-cols-8 border border-gray-200 rounded-lg overflow-hidden';
                    
                    // Time labels column
                    const timeLabels = document.createElement('div');
                    timeLabels.className = 'col-span-1 bg-gray-50';
                    
                    // Empty cell for the top-left corner
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'h-12 border-b border-r border-gray-200 bg-gray-50';
                    timeLabels.appendChild(emptyCell);
                    
                    // Time labels from 8 AM to 10 PM
                    for (let hour = 8; hour <= 22; hour++) {
                        const timeLabel = document.createElement('div');
                        timeLabel.className = 'h-[60px] border-b border-r border-gray-200 flex items-center justify-end pr-2 time-label text-gray-600';
                        const displayHour = hour % 12 || 12;
                        const ampm = hour < 12 ? 'AM' : 'PM';
                        timeLabel.textContent = `${displayHour}:00 ${ampm}`;
                        timeLabels.appendChild(timeLabel);
                    }
                    
                    calendarGrid.appendChild(timeLabels);
                    
                    // Day columns (Monday-Sunday)
                    const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                    for (let day = 0; day < 7; day++) {
                        const dayColumn = document.createElement('div');
                        dayColumn.className = 'col-span-1';
                        
                        // Day header
                        const dayHeader = document.createElement('div');
                        dayHeader.className = 'h-12 border-b border-gray-200 flex items-center justify-center day-header font-medium bg-gray-50';
                        dayHeader.textContent = `${dayNames[day].substring(0,3)} ${formatDateCompact(currentDate)}`;
                        dayColumn.appendChild(dayHeader);
                        
                        // Time slots
                        for (let hour = 8; hour <= 22; hour++) {
                            const timeSlot = document.createElement('div');
                            timeSlot.className = 'drop-zone h-[60px] border-b border-gray-200 relative';
                            timeSlot.dataset.date = currentDate.toISOString().split('T')[0];
                            timeSlot.dataset.hour = hour;
                            timeSlot.dataset.week = week;
                            timeSlot.dataset.day = day;
                            
                            // Ensure drop events are properly set up
                            timeSlot.addEventListener('dragover', handleDragOver);
                            timeSlot.addEventListener('dragleave', handleDragLeave);
                            timeSlot.addEventListener('drop', handleDrop);
                            timeSlot.addEventListener('dragenter', e => e.preventDefault());
                            
                            // Check if there's any visit that occupies this time slot
                            const slotHour = parseInt(timeSlot.dataset.hour);
                            const visit = periodData[currentPeriod].scheduledVisits.find(v => {
                                const visitEndHour = v.hour + v.duration;
                                return (
                                    v.date === timeSlot.dataset.date &&
                                    v.week === week &&
                                    v.day === day &&
                                    slotHour >= v.hour &&
                                    slotHour < visitEndHour
                                );
                            });
                            
                            if (visit && visit.hour === slotHour) {
                                // Only create tile for the starting hour to avoid duplicates
                                const visitTile = createScheduledVisitTile(visit);
                                timeSlot.appendChild(visitTile);
                            }
                            
                            dayColumn.appendChild(timeSlot);
                        }
                        
                        calendarGrid.appendChild(dayColumn);
                        // Increment date for next day (Monday-Sunday)
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    
                    weekContainer.appendChild(calendarGrid);
                    calendarWeeks.appendChild(weekContainer);
                }
            }

            // Handle drag over event for time slots
            function handleDragOver(e) {
                e.preventDefault();
                e.currentTarget.classList.add('bg-[#ffeab6]');
            }

            // Handle drag leave event for time slots
            function handleDragLeave(e) {
                e.currentTarget.classList.remove('bg-[#ffeab6]');
            }

            // Handle drop event for time slots
            function handleDrop(e) {
                e.preventDefault();
                e.currentTarget.classList.remove('bg-[#ffeab6]');
                
                const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                const timeSlot = e.currentTarget;
                
                // Get visit type info (but don't enforce limits)
                const visitType = visitTypes.find(t => t.id === data.type);
                
                // Check for overlapping visits in current period
                const startHour = parseInt(timeSlot.dataset.hour);
                const endHour = startHour + data.duration;
                const date = timeSlot.dataset.date;
                const week = parseInt(timeSlot.dataset.week);
                const day = parseInt(timeSlot.dataset.day);
                
                const hasOverlap = periodData[currentPeriod].scheduledVisits.some(visit => {
                    const visitEndHour = visit.hour + visit.duration;
                    return (
                        visit.date === date &&
                        visit.week === week &&
                        visit.day === day &&
                        ((startHour >= visit.hour && startHour < visitEndHour) ||
                        (endHour > visit.hour && endHour <= visitEndHour) ||
                        (startHour <= visit.hour && endHour >= visitEndHour))
                    );
                });
                
                if (hasOverlap) {
                    alert('This time slot overlaps with an existing visit.');
                    return;
                }
                
                // Create the visit tile in the calendar
                const visit = {
                    type: data.type,
                    duration: data.duration,
                    location: restaurantNameInput.value || 'Restaurant',
                    date: timeSlot.dataset.date,
                    hour: parseInt(timeSlot.dataset.hour),
                    week: parseInt(timeSlot.dataset.week),
                    day: parseInt(timeSlot.dataset.day)
                };
                
                const visitTile = createScheduledVisitTile(visit);
                timeSlot.appendChild(visitTile);
                
                // Add to scheduled visits
                periodData[currentPeriod].scheduledVisits.push(visit);
                saveToSessionStorage();
                
                // Update visit bank to reflect remaining uses
                updateVisitBank();
            }

            // Create a scheduled visit tile
            function createScheduledVisitTile(visit) {
                const visitType = visitTypes.find(t => t.id === visit.type);
                const isShortDuration = visit.duration <= 1.5;
                
                const tile = document.createElement('div');
                tile.className = `visit-tile ${visitType.color} p-2 rounded-md absolute top-0 left-0 right-0 bottom-0 flex flex-col justify-between font-medium leading-tight`;
                tile.style.wordBreak = 'break-word';
                tile.style.overflowWrap = 'anywhere';
                tile.dataset.visitId = `${visit.date}-${visit.hour}-${visit.week}-${visit.day}`;
                
                const tileTitle = document.createElement('div');
                tileTitle.className = visit.duration <= 1.5 ? 'font-bold text-xs' : 'font-bold text-sm';
                tileTitle.style.whiteSpace = 'normal';
                tileTitle.style.wordBreak = 'break-word';
                tileTitle.textContent = visitType.name;
                
                // Add counter display for scheduled visits
                const counter = document.createElement('div');
                counter.className = `text-xs ${visitType.id === 'cash-audit' || visitType.id === 'competency' ? 'text-black' : 'text-gray-200'}`;
                counter.innerHTML = `
                    <div class="flex justify-between text-[10px]">
                        <span>Req</span>
                        <span>Sch</span>
                        <span>Rem</span>
                    </div>
                    <div class="flex justify-between text-[11px] font-medium">
                        <span>${visitType.perRestaurant ? visitType.maxPerRestaurant * restaurantCount : visitType.maxPerGarden || 1}</span>
                        <span>${periodData[currentPeriod].scheduledVisits.filter(v => v.type === visit.type).length}</span>
                        <span class="${((visitType.perRestaurant ? visitType.maxPerRestaurant * restaurantCount : visitType.maxPerGarden || 1) - 
                            periodData[currentPeriod].scheduledVisits.filter(v => v.type === visit.type).length) < 0 ? 'text-red-500' : ''}">
                            ${(visitType.perRestaurant ? visitType.maxPerRestaurant * restaurantCount : visitType.maxPerGarden || 1) - 
                            periodData[currentPeriod].scheduledVisits.filter(v => v.type === visit.type).length}
                        </span>
                    </div>
                `;
                
                const tileLocation = document.createElement('div');
                tileLocation.className = visit.duration <= 1.5 ? 'text-[10px]' : 'text-xs';
                tileLocation.textContent = visit.location;
                tileLocation.title = visit.location;
                
                // Delete button
                const deleteButton = document.createElement('button');
                deleteButton.className = visit.duration <= 1.5 
                    ? 'absolute top-0.5 right-0.5 text-white hover:text-gray-200 text-[10px]' 
                    : 'absolute top-1 right-1 text-white hover:text-gray-200 text-xs';
                deleteButton.innerHTML = '&times;';
                deleteButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const parent = tile.parentElement;
                    parent.removeChild(tile);
                    
                    // Remove from scheduled visits
                    periodData[currentPeriod].scheduledVisits = periodData[currentPeriod].scheduledVisits.filter(v => 
                        !(v.date === visit.date && 
                        v.hour === visit.hour &&
                        v.week === visit.week &&
                        v.day === visit.day)
                    );
                    saveToSessionStorage();
                    
                    // Update visit bank to reflect remaining uses
                    updateVisitBank();
                });
                
                tile.appendChild(tileTitle);
                tile.appendChild(tileLocation);
                tile.appendChild(deleteButton);
                
                // Set height based on duration
                tile.style.height = `${visit.duration * 60}px`;
                
                // Make draggable
                tile.draggable = true;
                tile.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', JSON.stringify({
                        visitId: tile.dataset.visitId,
                        type: visit.type,
                        duration: visit.duration,
                        location: visit.location
                    }));
                    e.target.classList.add('dragging');
                });
                
                return tile;
            }

            // Initialize the application
            init();

            // PDF Download functionality
            document.getElementById('downloadButton').addEventListener('click', async () => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Get all week containers
                const weeks = document.querySelectorAll('.print-week');
                
                for (let i = 0; i < weeks.length; i++) {
                    const week = weeks[i];
                    // Clone the week element to avoid affecting the original
                    const weekClone = week.cloneNode(true);
                    weekClone.style.position = 'absolute';
                    weekClone.style.left = '-9999px';
                    weekClone.style.top = '0';
                    weekClone.style.width = week.offsetWidth + 'px';
                    document.body.appendChild(weekClone);
                    
                    // Add extra space for headers
                    const headerHeight = 60;
                    weekClone.style.paddingTop = headerHeight + 'px';
                    
                    // Optional delay to ensure layout stability
                    await new Promise(resolve => setTimeout(resolve, 200));
                    
                    const canvas = await html2canvas(weekClone, {
                        scale: 3,
                        logging: false,
                        useCORS: true,
                        allowTaint: true,
                        scrollX: 0,
                        scrollY: -headerHeight,
                        windowHeight: weekClone.scrollHeight + headerHeight,
                        ignoreElements: (element) => {
                            return element.classList.contains('no-print');
                        },
                        onclone: (clonedDoc) => {
                            // Ensure visit tiles maintain their height
                            clonedDoc.querySelectorAll('.visit-tile').forEach(tile => {
                                tile.style.boxSizing = 'border-box';
                                tile.style.height = tile.offsetHeight + 'px';
                                tile.style.minHeight = tile.offsetHeight + 'px';
                            });
                            
                            // Keep sticky headers visible without disrupting layout
                            const headers = clonedDoc.querySelectorAll('.sticky.top-0');
                            headers.forEach(header => {
                                header.style.position = 'relative';
                            });
                            
                            clonedDoc.body.offsetHeight; // Force layout
                        }
                    });
                    
                    document.body.removeChild(weekClone);
                    
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 210; // A4 width in mm
                    const pageHeight = 297; // A4 height in mm
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    
                    // Add first page
                    if (i === 0) {
                        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                    } else {
                        // Add new page for additional weeks
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                    }
                }
                
                // Generate filename with period and user name
                const periodStr = `P${currentPeriod}`;
                const userNameStr = userName.replace(/\s+/g, '') || ''; // Remove spaces if present
                const filename = userNameStr 
                    ? `CAVA-Calendar-${periodStr}-${userNameStr}.pdf` 
                    : `CAVA-Calendar-${periodStr}.pdf`;
                
                pdf.save(filename);
            });
        });
    </script>
</body>
</html>