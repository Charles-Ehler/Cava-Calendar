<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAVA Area Leader VISIT Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @media print {
            .no-print {
                display: none !important;
            }
            .print-week {
                page-break-after: always;
            }
            .print-week:last-child {
                page-break-after: auto;
            }
            body {
                background-color: white !important;
                color: black !important;
            }
            .visit-tile {
                background-color: #f3f3f3 !important;
                border-color: #999 !important;
                color: black !important;
            }
            .time-label {
                color: black !important;
            }
            .day-header {
                color: black !important;
                border-color: #999 !important;
            }
        }
        
        .drop-zone {
            min-height: 60px;
        }
        
        .dragging {
            opacity: 0.5;
        }
        
        .period-tab.active {
            border-bottom: 4px solid #009ef4;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-[#ffeab6] min-h-screen font-sans">
    <div class="container mx-auto px-4 py-6">
        <!-- Header Section -->
        <header class="mb-8">
            <div class="flex items-center">
                <div class="w-16 h-16 bg-[#009ef4] rounded-lg flex items-center justify-center text-white font-bold text-xl mr-4">
                    CAVA
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-[#009ef4]">CAVA Area Leader VISIT Calendar</h1>
                    <p class="text-lg text-[#959502]">Schedule your visits for the selected period</p>
                </div>
            </div>
        </header>

        <!-- Period Tabs -->
        <div class="mb-6 overflow-x-auto">
            <div class="flex space-x-1 min-w-max">
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="1">P1</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="2">P2</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="3">P3</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="4">P4</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="5">P5</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="6">P6</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="7">P7</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="8">P8</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="9">P9</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="10">P10</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="11">P11</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100" data-period="12">P12</button>
                <button class="period-tab px-4 py-2 bg-white rounded-t-lg hover:bg-gray-100 active" data-period="13">P13</button>
            </div>
        </div>


        <!-- Main Content -->
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- Visit Bank -->
            <aside class="no-print w-full lg:w-1/4 bg-white p-4 rounded-lg shadow-md lg:sticky lg:top-4 lg:self-start">
                <div class="mb-4">
                    <label for="restaurantName" class="block text-sm font-medium text-gray-700 mb-1">Set Visits for the Following Restaurant</label>
                    <input type="text" id="restaurantName" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#009ef4]" placeholder="Restaurant Name">
                </div>
                <div class="mb-4">
                    <label for="restaurantCount" class="block text-sm font-medium text-gray-700 mb-1">Number of Restaurants</label>
                    <input type="number" id="restaurantCount" min="1" max="20" value="1" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#009ef4]">
                </div>
                <div class="mb-4">
                    <label for="userName" class="block text-sm font-medium text-gray-700 mb-1">Enter Your Name</label>
                    <input type="text" id="userName" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-[#009ef4]" placeholder="Your Name">
                </div>
                <button id="generateVisitsBtn" class="w-full px-4 py-3 bg-[#009ef4] text-white rounded-md hover:bg-[#0083d1] focus:outline-none focus:ring-2 focus:ring-[#009ef4] font-bold disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Generate Visits
                </button>
                <div id="visitBank" class="space-y-2 mt-4 hidden">
                    <h2 class="text-xl font-bold text-[#009ef4] mb-4">Visit Bank</h2>
                    <!-- Visit tiles will be generated here -->
                </div>
            </aside>

            <!-- Calendar -->
            <main class="w-full lg:w-3/4 bg-white p-4 rounded-lg shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-[#009ef4]">
                        <span id="currentPeriodDisplay">P13</span>: 
                        <span id="dateRangeDisplay">Dec 1 - Dec 28, 2025</span>
                    </h2>
                    <div class="flex gap-2 items-center justify-end">
                        <button id="downloadButton" class="no-print px-4 py-2 bg-[#009ef4] text-white rounded-md hover:bg-[#0083d1] focus:outline-none focus:ring-2 focus:ring-[#009ef4] font-medium">
                            Download Calendar (PDF)
                        </button>
                        <button id="resetButton" class="no-print px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-400 font-medium">
                            Reset Calendar
                        </button>
                    </div>
                </div>
                
                <div id="calendarContainer" class="border border-gray-200 rounded-lg">
                    <div id="calendarWeeks" class="min-w-max space-y-6">
                        <!-- Calendar weeks will be generated here -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Period data
            const periods = {
                1: { startDate: new Date('2024-12-30'), endDate: new Date('2025-01-26') },
                2: { startDate: new Date('2025-01-27'), endDate: new Date('2025-02-23') },
                3: { startDate: new Date('2025-02-24'), endDate: new Date('2025-03-23') },
                4: { startDate: new Date('2025-03-24'), endDate: new Date('2025-04-20') },
                5: { startDate: new Date('2025-04-21'), endDate: new Date('2025-05-18') },
                6: { startDate: new Date('2025-05-19'), endDate: new Date('2025-06-15') },
                7: { startDate: new Date('2025-06-16'), endDate: new Date('2025-07-13') },
                8: { startDate: new Date('2025-07-14'), endDate: new Date('2025-08-10') },
                9: { startDate: new Date('2025-08-11'), endDate: new Date('2025-09-07') },
                10: { startDate: new Date('2025-09-08'), endDate: new Date('2025-10-05') },
                11: { startDate: new Date('2025-10-06'), endDate: new Date('2025-11-02') },
                12: { startDate: new Date('2025-11-03'), endDate: new Date('2025-11-30') },
                13: { startDate: new Date('2025-12-01'), endDate: new Date('2025-12-28') }
            };

            // Visit types data with updated rules
            const visitTypes = [
                { 
                    id: 'qra', 
                    name: 'Quarterly Restaurant Audit (QRA)', 
                    duration: 5, 
                    color: 'bg-[#009ef4] text-white', 
                    periods: [1, 5, 8, 11], 
                    perRestaurant: true,
                    maxPerRestaurant: 1,
                    description: '1 per restaurant in P1, P5, P8, P11'
                },
                { 
                    id: 'coaching', 
                    name: 'Coaching Visit', 
                    duration: 2, 
                    color: 'bg-[#959502] text-white', 
                    periods: [2, 3, 4, 6, 7, 9, 10, 12, 13], 
                    perRestaurant: true,
                    maxPerRestaurant: 1,
                    description: '1 per restaurant in P2-P4, P6-P7, P9-P10, P12-P13'
                },
                { 
                    id: 'cash-audit', 
                    name: 'Cash Audit', 
                    duration: 1, 
                    color: 'bg-[#bcdaff] text-black', 
                    periods: 'all', 
                    perRestaurant: true,
                    maxPerRestaurant: 1,
                    description: '1 per restaurant every period'
                },
                { 
                    id: 'gm-impact', 
                    name: 'GM Impact Plan Conversation', 
                    duration: 1, 
                    color: 'bg-[#ff9d00] text-white', 
                    periods: 'all', 
                    perRestaurant: true,
                    maxPerRestaurant: 1,
                    description: '1 per restaurant every period'
                },
                { 
                    id: 'guest-exp', 
                    name: 'Guest Experience Night/Weekend Visit', 
                    duration: 1.5, 
                    color: 'bg-[#da3d9d] text-white', 
                    periods: 'all', 
                    perRestaurant: true,
                    maxPerRestaurant: 1,
                    description: '1 per restaurant every period'
                },
                { 
                    id: 'competency', 
                    name: 'Competency Champion Training', 
                    duration: 1, 
                    color: 'bg-[#e8b2ee] text-black', 
                    periods: 'all', 
                    perRestaurant: false,
                    maxPerGarden: 1,
                    description: '1 per garden/region every period'
                },
                { 
                    id: 'station', 
                    name: 'Station Training Workshop', 
                    duration: 2, 
                    color: 'bg-[#ff9d77] text-white', 
                    periods: 'all', 
                    perRestaurant: false,
                    maxPerGarden: 1,
                    description: '1 per garden/region every period'
                }
            ];

            // State variables
            let currentPeriod = 1;
            let restaurantName = '';
            let restaurantCount = 1;
            let userName = '';
            // Track period-specific data
            const periodData = {};
            for (let i = 1; i <= 13; i++) {
                periodData[i] = {
                    scheduledVisits: [],
                    remainingUses: {}
                };
                // Initialize remainingUses for all visit types with 0
                visitTypes.forEach(type => {
                    periodData[i].remainingUses[type.id] = 0;
                });
            }

            // DOM elements
            const periodTabs = document.querySelectorAll('.period-tab');
            const restaurantNameInput = document.getElementById('restaurantName');
            const restaurantCountInput = document.getElementById('restaurantCount');
            const userNameInput = document.getElementById('userName');
            const visitBank = document.getElementById('visitBank');
            const calendarWeeks = document.getElementById('calendarWeeks');
            const currentPeriodDisplay = document.getElementById('currentPeriodDisplay');
            const dateRangeDisplay = document.getElementById('dateRangeDisplay');
            const printButton = document.getElementById('printButton');

            // Initialize the application
            function init() {
                loadFromSessionStorage();
                setupEventListeners();
                
                // Hide visit bank by default - it will show when Generate Visits is clicked
                document.getElementById('visitBank').classList.add('hidden');
                
                renderCalendar();
                updateGenerateButtonState();
            }

            // Load data from session storage
            function loadFromSessionStorage() {
                if (sessionStorage.getItem('cavaCalendar')) {
                    const savedData = JSON.parse(sessionStorage.getItem('cavaCalendar'));
                    currentPeriod = savedData.currentPeriod || 13;
                    restaurantName = savedData.restaurantName || '';
                    restaurantCount = savedData.restaurantCount || 1;
                    userName = savedData.userName || '';
                    // Load period data if it exists
                    if (savedData.periodData) {
                        for (let i = 1; i <= 13; i++) {
                            if (savedData.periodData[i]) {
                                periodData[i] = savedData.periodData[i];
                            }
                        }
                    }
                    
                    // Update UI
                    restaurantNameInput.value = restaurantName;
                    restaurantCountInput.value = restaurantCount;
                    userNameInput.value = userName;
                    
                    // Update active period tab
                    periodTabs.forEach(tab => {
                        tab.classList.remove('active');
                        if (parseInt(tab.dataset.period) === currentPeriod) {
                            tab.classList.add('active');
                        }
                    });
                    
                    currentPeriodDisplay.textContent = `P${currentPeriod}`;
                    updateDateRangeDisplay();
                }
            }

            // Save data to session storage
            function saveToSessionStorage() {
                const data = {
                    currentPeriod,
                    restaurantName,
                    restaurantCount,
                    userName,
                    periodData
                };
                sessionStorage.setItem('cavaCalendar', JSON.stringify(data));
            }

            // Update generate button state based on input fields
            function updateGenerateButtonState() {
                const generateBtn = document.getElementById('generateVisitsBtn');
                generateBtn.disabled = !(restaurantName && restaurantCount && userName);
            }

            // Set up event listeners
            function setupEventListeners() {
                // Input change listeners
                restaurantNameInput.addEventListener('input', () => {
                    restaurantName = restaurantNameInput.value;
                    updateGenerateButtonState();
                    saveToSessionStorage();
                });

                restaurantCountInput.addEventListener('change', () => {
                    restaurantCount = parseInt(restaurantCountInput.value);
                    updateGenerateButtonState();
                    saveToSessionStorage();
                });

                userNameInput.addEventListener('input', () => {
                    userName = userNameInput.value;
                    updateGenerateButtonState();
                    saveToSessionStorage();
                });

                // Generate visits button
                document.getElementById('generateVisitsBtn').addEventListener('click', () => {
                    // Update state from inputs
                    restaurantName = restaurantNameInput.value;
                    restaurantCount = parseInt(restaurantCountInput.value);
                    userName = userNameInput.value;

                    // Initialize remaining uses based on visit type rules
                    visitTypes.forEach(type => {
                        if (type.periods === 'all' || type.periods.includes(currentPeriod)) {
                            if (type.perRestaurant) {
                                periodData[currentPeriod].remainingUses[type.id] = 
                                    type.maxPerRestaurant * restaurantCount;
                            } else {
                                periodData[currentPeriod].remainingUses[type.id] = 
                                    type.maxPerGarden || 1;
                            }
                        } else {
                            periodData[currentPeriod].remainingUses[type.id] = 0;
                        }
                    });

                    // Show visit bank and update
                    document.getElementById('visitBank').classList.remove('hidden');
                    updateVisitBank();
                    renderCalendar();
                    saveToSessionStorage();
                    
                    // Ensure drag events are properly set up for new tiles
                    document.querySelectorAll('.visit-tile[draggable="true"]').forEach(tile => {
                        tile.addEventListener('dragstart', handleDragStart);
                    });
                });
                // Period tabs
                periodTabs.forEach(tab => {
                    tab.addEventListener('click', () => {
                        currentPeriod = parseInt(tab.dataset.period);
                        periodTabs.forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        currentPeriodDisplay.textContent = `P${currentPeriod}`;
                        updateDateRangeDisplay();
                        updateVisitBank();
                        renderCalendar();
                        saveToSessionStorage();
                        
                        // Ensure drag events are properly set up for new tiles
                        document.querySelectorAll('.visit-tile[draggable="true"]').forEach(tile => {
                            tile.addEventListener('dragstart', handleDragStart);
                        });
                    });
                });


                // Reset button
                document.getElementById('resetButton').addEventListener('click', () => {
                    if (confirm('Are you sure you want to reset the calendar? This will remove all scheduled visits.')) {
                        periodData[currentPeriod].scheduledVisits = [];
                        saveToSessionStorage();
                        renderCalendar();
                        updateVisitBank();
                        // Refresh drag-and-drop listeners
                        document.querySelectorAll('.visit-tile[draggable="true"]').forEach(tile => {
                            tile.addEventListener('dragstart', handleDragStart);
                        });
                        document.querySelectorAll('.drop-zone').forEach(zone => {
                            zone.addEventListener('dragover', handleDragOver);
                            zone.addEventListener('dragleave', handleDragLeave);
                            zone.addEventListener('drop', handleDrop);
                            zone.addEventListener('dragenter', e => e.preventDefault());
                        });
                    }
                });
            }

            // Update the date range display
            function updateDateRangeDisplay() {
                const period = periods[currentPeriod];
                const startDate = period.startDate;
                const endDate = period.endDate;
                
                const startStr = formatDate(startDate);
                const endStr = formatDate(endDate);
                
                dateRangeDisplay.textContent = `${startStr} - ${endStr}`;
            }

            // Format date as "Mon 3/3"
            function formatDate(date) {
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const dayName = days[date.getDay()];
                const month = date.getMonth() + 1;
                const day = date.getDate();
                const year = date.getFullYear();
                
                return `${dayName} ${month}/${day}/${year}`;
            }

            // Format date as "Mon 3/3" (short version)
            function formatDateShort(date) {
                const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const dayName = days[date.getDay()];
                const month = date.getMonth() + 1;
                const day = date.getDate();
                
                return `${dayName} ${month}/${day}`;
            }

            // Track remaining uses for each visit type
            const remainingUses = {};

            // Update the visit bank based on current period and restaurant count
            function updateVisitBank() {
                visitBank.innerHTML = '';
                
                const currentVisitTypes = visitTypes.filter(type => {
                    const isInPeriod = type.periods === 'all' || type.periods.includes(currentPeriod);
                    const hasRemainingUses = periodData[currentPeriod].remainingUses[type.id] > 0;
                    return isInPeriod && hasRemainingUses;
                });
                
                currentVisitTypes.forEach(type => {
                    // Calculate used count for this type
                    const usedCount = periodData[currentPeriod].scheduledVisits.filter(v => v.type === type.id).length;
                    const remaining = (periodData[currentPeriod].remainingUses[type.id] || 0) - usedCount;
                    
                    // Create just one tile per type
                    const location = type.perRestaurant ? 
                        (restaurantName ? restaurantName : 'Restaurant') : 
                        'Garden';
                    createVisitTile(type, location, remaining > 0);
                });
            }

            // Create a visit tile in the visit bank
            function createVisitTile(type, location, isActive) {
                const isShortDuration = type.duration <= 1.5;
                
                const tile = document.createElement('div');
                tile.className = `visit-tile ${type.color} ${
                    isShortDuration ? 'px-1 py-0.5' : 'p-2'
                } rounded-md h-24 flex flex-col justify-between font-medium leading-tight`;
                tile.dataset.type = type.id;
                tile.dataset.duration = type.duration;
                tile.dataset.location = location;
                tile.draggable = isActive;
                
                if (isActive) {
                    tile.classList.add('cursor-move');
                    tile.addEventListener('dragstart', handleDragStart);
                } else {
                    tile.classList.add('opacity-50', 'cursor-not-allowed');
                }
                
                const tileTitle = document.createElement('div');
                tileTitle.className = isShortDuration ? 'font-bold text-xs truncate' : 'font-bold text-sm';
                tileTitle.textContent = type.name;
                tileTitle.title = type.name;
                
                const tileLocation = document.createElement('div');
                tileLocation.className = isShortDuration ? 'text-[10px] truncate' : 'text-xs';
                tileLocation.textContent = location;
                tileLocation.title = location;
                
                // Calculate remaining uses
                const usedCount = periodData[currentPeriod].scheduledVisits.filter(v => v.type === type.id).length;
                const remaining = (periodData[currentPeriod].remainingUses[type.id] || 0) - usedCount;
                
                // Add remaining uses indicator
                const usesIndicator = document.createElement('div');
                usesIndicator.className = `${
                    isShortDuration ? 'text-[9px]' : 'text-xs'
                } ${type.id === 'cash-audit' || type.id === 'competency' ? 'text-black' : 'text-gray-200'}`;
                
                if (type.perRestaurant) {
                    usesIndicator.textContent = `${remaining} remaining`;
                } else {
                    usesIndicator.textContent = remaining > 0 ? 'Available' : 'Already scheduled';
                }
                
                const durationText = document.createElement('div');
                durationText.className = `text-xs ${type.id === 'cash-audit' || type.id === 'competency' ? 'text-black' : 'text-gray-200'}`;
                // Format duration display
                let durationTextStr;
                if (type.duration % 1 === 0) {
                    durationTextStr = `${type.duration} ${type.duration === 1 ? 'hr' : 'hrs'}`;
                } else {
                    durationTextStr = `${type.duration * 60} mins`;
                }
                durationText.textContent = durationTextStr;
                
                tile.appendChild(tileTitle);
                tile.appendChild(tileLocation);
                tile.appendChild(durationText);
                tile.appendChild(usesIndicator);
                
                // Update location text for restaurant visits
                const locationText = type.perRestaurant ? 
                    (restaurantName ? restaurantName : 'Restaurant') : 
                    location;
                
                visitBank.appendChild(tile);
            }

            // Handle drag start for visit tiles
            function handleDragStart(e) {
                const data = {
                    type: e.target.dataset.type,
                    duration: parseFloat(e.target.dataset.duration),
                    location: e.target.dataset.location
                };
                e.dataTransfer.setData('text/plain', JSON.stringify(data));
                e.target.classList.add('dragging');
                
                // Create and set custom drag image
                const dragImage = e.target.cloneNode(true);
                dragImage.style.width = `${e.target.offsetWidth}px`;
                dragImage.style.height = `${e.target.offsetHeight}px`;
                dragImage.style.position = 'fixed';
                dragImage.style.left = '-9999px';
                dragImage.style.opacity = '0.8';
                document.body.appendChild(dragImage);
                
                e.dataTransfer.setDragImage(dragImage, e.target.offsetWidth / 2, e.target.offsetHeight / 2);
                
                // Clean up after drag ends
                const cleanup = () => {
                    document.body.removeChild(dragImage);
                    e.target.classList.remove('dragging');
                    document.removeEventListener('dragend', cleanup);
                };
                document.addEventListener('dragend', cleanup, { once: true });
            }

            // Render the calendar
            function renderCalendar() {
                calendarWeeks.innerHTML = '';
                
                const period = periods[currentPeriod];
                let currentDate = new Date(period.startDate);
                
                // Create 4 weeks
                for (let week = 1; week <= 4; week++) {
                    const weekContainer = document.createElement('div');
                    weekContainer.className = 'print-week mb-8';
                    
                    // Week label
                    const weekLabel = document.createElement('div');
                    weekLabel.className = 'text-lg font-bold text-[#009ef4] mb-2 sticky top-0 bg-white z-10';
                    weekLabel.textContent = `Week ${week}`;
                    weekContainer.appendChild(weekLabel);
                    
                    // Calendar grid
                    const calendarGrid = document.createElement('div');
                    calendarGrid.className = 'grid grid-cols-8 border border-gray-200 rounded-lg overflow-hidden';
                    
                    // Time labels column
                    const timeLabels = document.createElement('div');
                    timeLabels.className = 'col-span-1 bg-gray-50';
                    
                    // Empty cell for the top-left corner
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'h-12 border-b border-r border-gray-200 bg-gray-50';
                    timeLabels.appendChild(emptyCell);
                    
                    // Time labels from 8 AM to 10 PM
                    for (let hour = 8; hour <= 22; hour++) {
                        const timeLabel = document.createElement('div');
                        timeLabel.className = 'h-[60px] border-b border-r border-gray-200 flex items-center justify-end pr-2 time-label text-gray-600';
                        const displayHour = hour % 12 || 12;
                        const ampm = hour < 12 ? 'AM' : 'PM';
                        timeLabel.textContent = `${displayHour}:00 ${ampm}`;
                        timeLabels.appendChild(timeLabel);
                    }
                    
                    calendarGrid.appendChild(timeLabels);
                    
                    // Day columns
                    for (let day = 0; day < 7; day++) {
                        const dayColumn = document.createElement('div');
                        dayColumn.className = 'col-span-1';
                        
                        // Day header
                        const dayHeader = document.createElement('div');
                        dayHeader.className = 'h-12 border-b border-gray-200 flex items-center justify-center day-header font-medium bg-gray-50';
                        dayHeader.textContent = formatDateShort(currentDate);
                        dayColumn.appendChild(dayHeader);
                        
                        // Time slots
                        for (let hour = 8; hour <= 22; hour++) {
                            const timeSlot = document.createElement('div');
                            timeSlot.className = 'drop-zone h-[60px] border-b border-gray-200 relative';
                            timeSlot.dataset.date = currentDate.toISOString().split('T')[0];
                            timeSlot.dataset.hour = hour;
                            timeSlot.dataset.week = week;
                            timeSlot.dataset.day = day;
                            
                            // Ensure drop events are properly set up
                            timeSlot.addEventListener('dragover', handleDragOver);
                            timeSlot.addEventListener('dragleave', handleDragLeave);
                            timeSlot.addEventListener('drop', handleDrop);
                            timeSlot.addEventListener('dragenter', e => e.preventDefault());
                            
                            // Check if there's any visit that occupies this time slot
                            const slotHour = parseInt(timeSlot.dataset.hour);
                            const visit = periodData[currentPeriod].scheduledVisits.find(v => {
                                const visitEndHour = v.hour + v.duration;
                                return (
                                    v.date === timeSlot.dataset.date &&
                                    v.week === week &&
                                    v.day === day &&
                                    slotHour >= v.hour &&
                                    slotHour < visitEndHour
                                );
                            });
                            
                            if (visit && visit.hour === slotHour) {
                                // Only create tile for the starting hour to avoid duplicates
                                const visitTile = createScheduledVisitTile(visit);
                                timeSlot.appendChild(visitTile);
                            }
                            
                            dayColumn.appendChild(timeSlot);
                        }
                        
                        calendarGrid.appendChild(dayColumn);
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                    
                    weekContainer.appendChild(calendarGrid);
                    calendarWeeks.appendChild(weekContainer);
                }
            }

            // Handle drag over event for time slots
            function handleDragOver(e) {
                e.preventDefault();
                e.currentTarget.classList.add('bg-[#ffeab6]');
            }

            // Handle drag leave event for time slots
            function handleDragLeave(e) {
                e.currentTarget.classList.remove('bg-[#ffeab6]');
            }

            // Handle drop event for time slots
            function handleDrop(e) {
                e.preventDefault();
                e.currentTarget.classList.remove('bg-[#ffeab6]');
                
                const data = JSON.parse(e.dataTransfer.getData('text/plain'));
                const timeSlot = e.currentTarget;
                
                // Check visit type limits
                const visitType = visitTypes.find(t => t.id === data.type);
                const usedCount = periodData[currentPeriod].scheduledVisits.filter(v => v.type === data.type).length;
                
                if (visitType.perRestaurant) {
                    const maxAllowed = visitType.maxPerRestaurant * restaurantCount;
                    if (usedCount >= maxAllowed) {
                        alert(`You've already scheduled all ${maxAllowed} ${visitType.name} visits for this period`);
                        return;
                    }
                } else {
                    const maxAllowed = visitType.maxPerGarden || 1;
                    if (usedCount >= maxAllowed) {
                        alert(`You can only schedule ${maxAllowed} ${visitType.name} per period`);
                        return;
                    }
                }
                
                // Check for overlapping visits in current period
                const startHour = parseInt(timeSlot.dataset.hour);
                const endHour = startHour + data.duration;
                const date = timeSlot.dataset.date;
                const week = parseInt(timeSlot.dataset.week);
                const day = parseInt(timeSlot.dataset.day);
                
                const hasOverlap = periodData[currentPeriod].scheduledVisits.some(visit => {
                    const visitEndHour = visit.hour + visit.duration;
                    return (
                        visit.date === date &&
                        visit.week === week &&
                        visit.day === day &&
                        ((startHour >= visit.hour && startHour < visitEndHour) ||
                         (endHour > visit.hour && endHour <= visitEndHour) ||
                         (startHour <= visit.hour && endHour >= visitEndHour))
                    );
                });
                
                if (hasOverlap) {
                    alert('This time slot overlaps with an existing visit.');
                    return;
                }
                
                // Create the visit tile in the calendar
                const visit = {
                    type: data.type,
                    duration: data.duration,
                    location: data.location,
                    date: timeSlot.dataset.date,
                    hour: parseInt(timeSlot.dataset.hour),
                    week: parseInt(timeSlot.dataset.week),
                    day: parseInt(timeSlot.dataset.day)
                };
                
                const visitTile = createScheduledVisitTile(visit);
                timeSlot.appendChild(visitTile);
                
                // Add to scheduled visits
                periodData[currentPeriod].scheduledVisits.push(visit);
                saveToSessionStorage();
                
                // Update visit bank to reflect remaining uses
                updateVisitBank();
            }

            // Create a scheduled visit tile
            function createScheduledVisitTile(visit) {
                const visitType = visitTypes.find(t => t.id === visit.type);
                const isShortDuration = visit.duration <= 1.5;
                
                const tile = document.createElement('div');
                tile.className = `visit-tile ${visitType.color} ${
                    isShortDuration ? 'px-1 py-0.5' : 'p-2'
                } rounded-md absolute top-0 left-0 right-0 bottom-0 overflow-hidden flex flex-col justify-between font-medium leading-tight`;
                tile.dataset.visitId = `${visit.date}-${visit.hour}-${visit.week}-${visit.day}`;
                
                const tileTitle = document.createElement('div');
                tileTitle.className = isShortDuration ? 'font-bold text-xs truncate' : 'font-bold text-sm';
                tileTitle.textContent = visitType.name;
                tileTitle.title = visitType.name; // Add tooltip for truncated text
                
                const tileLocation = document.createElement('div');
                tileLocation.className = isShortDuration ? 'text-[10px] truncate' : 'text-xs';
                tileLocation.textContent = visit.location;
                tileLocation.title = visit.location; // Add tooltip for truncated text
                
                const timeDisplay = document.createElement('div');
                timeDisplay.className = `${
                    isShortDuration ? 'text-[10px]' : 'text-xs'
                } ${visit.type === 'cash-audit' || visit.type === 'competency' ? 'text-black' : ''}`;
                const startHour = visit.hour % 12 || 12;
                const startAmpm = visit.hour < 12 ? 'AM' : 'PM';
                const endHour = (visit.hour + visit.duration) % 12 || 12;
                const endAmpm = (visit.hour + visit.duration) < 12 ? 'AM' : 'PM';
                timeDisplay.textContent = `${startHour}:00 ${startAmpm} - ${endHour}:00 ${endAmpm}`;
                
                // Delete button
                const deleteButton = document.createElement('button');
                deleteButton.className = `absolute ${
                    isShortDuration ? 'top-0.5 right-0.5' : 'top-1 right-1'
                } text-white hover:text-gray-200 text-xs`;
                deleteButton.innerHTML = '&times;';
                deleteButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const parent = tile.parentElement;
                    parent.removeChild(tile);
                    
                    // Remove from scheduled visits
                    periodData[currentPeriod].scheduledVisits = periodData[currentPeriod].scheduledVisits.filter(v => 
                        !(v.date === visit.date && 
                          v.hour === visit.hour &&
                          v.week === visit.week &&
                          v.day === visit.day)
                    );
                    saveToSessionStorage();
                    
                    // Update visit bank to reflect remaining uses
                    updateVisitBank();
                });
                
                tile.appendChild(tileTitle);
                tile.appendChild(tileLocation);
                tile.appendChild(timeDisplay);
                tile.appendChild(deleteButton);
                
                // Set height based on duration
                tile.style.height = `${visit.duration * 60}px`;
                
                // Make draggable
                tile.draggable = true;
                tile.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', JSON.stringify({
                        visitId: tile.dataset.visitId,
                        type: visit.type,
                        duration: visit.duration,
                        location: visit.location
                    }));
                    e.target.classList.add('dragging');
                });
                
                return tile;
            }

            // Initialize the application
            init();

            // PDF Download functionality
            document.getElementById('downloadButton').addEventListener('click', async () => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                // Get all week containers
                const weeks = document.querySelectorAll('.print-week');
                
                for (let i = 0; i < weeks.length; i++) {
                    const week = weeks[i];
                    const canvas = await html2canvas(week, {
                        scale: 2,
                        logging: false,
                        useCORS: true,
                        allowTaint: true,
                        scrollX: 0,
                        scrollY: 0
                    });
                    
                    const imgData = canvas.toDataURL('image/png');
                    const imgWidth = 210; // A4 width in mm
                    const pageHeight = 297; // A4 height in mm
                    const imgHeight = canvas.height * imgWidth / canvas.width;
                    
                    // Add first page
                    if (i === 0) {
                        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                    } else {
                        // Add new page for additional weeks
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                    }
                }
                
                pdf.save('CAVA-Calendar.pdf');
            });
        });
    </script>
</body>
</html>